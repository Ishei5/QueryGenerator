# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path

name: Maven Package

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        type: environment
        required: true

jobs:
  build_jar:
    name: Build jar
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'
      - name: Build with Maven
        run: mvn clean install
      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v3
        with:
          name: QueryGenerator-1.0-SNAPSHOT.jar
          path: ${{ github.workspace }}/target/QueryGenerator-1.0-SNAPSHOT.jar
  
  deploy_prod:
    name: Deploy to prod environment
    if: inputs.environment == 'Production'
    runs-on: ubuntu-latest
    needs: build_jar
    environment:
      name: "Production"

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v3
        with:
          name: QueryGenerator-1.0-SNAPSHOT.jar

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: unnecessary
            -
      - name: Adding Known Hosts
        run: ssh-keyscan -p ${{ secrets.SSH_PORT}} -H ${{ secrets.SSH_HOST }}  >> ~/.ssh/known_hosts

      - name: Copy artifact to remote host
        run: scp ./QueryGenerator-1.0-SNAPSHOT.jar ubuntu@3.77.20.61:${{ vars.DEST_DIR }}
  
  deploy_dev:
    name: Deploy to dev environment
    if: inputs.environment == 'Development'
    runs-on: ubuntu-latest
    needs: build_jar
    environment:
      name: "Development"

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v3
        with:
          name: QueryGenerator-1.0-SNAPSHOT.jar

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: unnecessary
            -
      - name: Adding Known Hosts
        run: ssh-keyscan -p ${{ secrets.SSH_PORT}} -H ${{ secrets.SSH_HOST }}  >> ~/.ssh/known_hosts

      - name: Copy artifact to remote host
        run: scp ./QueryGenerator-1.0-SNAPSHOT.jar ubuntu@3.77.20.61:${{ vars.DEST_DIR }}
        
      - name: Send some mail
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          port: 465
          username: pankovisheev5@gmail.com
          password: ${{secrets.MAIL_PASS}}
          subject: Workflow finished
          body: Job completed ${{job.status}}. Спасибо за внивание)
          to: pankov_isheev@rambler.ru, pankovisheev5@gmail.com
          from: pankovisheev5@gmail.com
